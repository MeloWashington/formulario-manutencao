<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE VALIDACAO DE OS - AGE FIBRA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --primary-light: #3a506b;
            --secondary: #4361ee;
            --accent: #06d6a0;
            --light: #f8f9fa;
            --gray: #e9ecef;
            --dark: #212529;
            --success: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --border: #ced4da;
            --info: #118ab2;
            --purple: #7209b7;
            --today-highlight: #fff3cd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f0f4f8, #e2e8f0);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-bottom: 5px solid var(--secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logo i {
            font-size: 2.8rem;
            color: var(--secondary);
            background: linear-gradient(to right, var(--secondary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h1 {
            color: var(--primary);
            font-size: 2.3rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, var(--secondary), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #495057;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .form-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 178, 0.08);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray);
        }

        .section-title i {
            font-size: 1.6rem;
            color: var(--secondary);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary);
        }

        .required::after {
            content: " *";
            color: var(--danger);
        }

        select, input, textarea {
            width: 100%;
            padding: 13px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1.05rem;
            background-color: white;
            transition: all 0.3s ease;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
        }

        select:disabled {
            background-color: #f9f9f9;
            cursor: not-allowed;
        }

        .validation-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 12px;
            background-color: #f8fbff;
            border-left: 4px solid var(--secondary);
            transition: all 0.3s ease;
            opacity: 0.5;
            max-height: 60px;
            overflow: hidden;
        }

        .validation-item.active {
            opacity: 1;
            max-height: 300px;
            background-color: white;
            border-left: 4px solid var(--success);
        }

        .validation-item.completed {
            border-left: 4px solid var(--secondary);
        }

        .validation-item:hover {
            background-color: var(--light);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radio-option input {
            width: auto;
        }

        .validation-text {
            flex: 1;
        }

        .validation-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .comment-field {
            margin-top: 15px;
        }

        .comment-field input {
            padding: 10px 14px;
            font-size: 0.95rem;
        }

        .btn-submit {
            background: linear-gradient(to right, var(--secondary), var(--purple));
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.15rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
            max-width: 350px;
            margin: 40px auto 20px;
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }

        .btn-whatsapp {
            background: linear-gradient(to right, #25D366, #128C7E);
            color: white;
            border: none;
            padding: 16px 32px;
            font-size: 1.15rem;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            width: 100%;
            max-width: 350px;
            margin: 20px auto;
            box-shadow: 0 6px 15px rgba(37, 211, 102, 0.4);
        }

        .btn-submit:hover, .btn-whatsapp:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.5);
        }

        .btn-submit:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 25px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            border-left: 5px solid;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-top: 4px solid var(--secondary);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.1rem;
            font-weight: bold;
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.95rem;
            color: #6c757d;
            font-weight: 600;
        }

        .last-orders {
            margin-top: 35px;
        }

        .last-orders h3 {
            color: var(--primary);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .last-orders h3 i {
            font-size: 1.4rem;
            color: var(--secondary);
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .orders-table th {
            background: linear-gradient(to right, var(--secondary), var(--purple));
            color: white;
            text-align: left;
            padding: 14px 18px;
            font-weight: 600;
        }

        .orders-table td {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
        }

        .orders-table tr:nth-child(even) {
            background-color: var(--light);
        }

        .orders-table tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .status-approved {
            color: var(--success);
            font-weight: bold;
        }

        .status-rejected {
            color: var(--danger);
            font-weight: bold;
            background-color: rgba(239, 71, 111, 0.1);
            border-radius: 5px;
            padding: 5px 10px;
        }

        .today-order {
            background-color: var(--today-highlight);
            border-left: 4px solid var(--warning);
        }

        .export-btn {
            background: linear-gradient(to right, var(--primary), var(--primary-light));
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.05rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 18px;
        }

        .export-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3);
        }

        .delete-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .delete-btn:hover {
            background-color: #d0004b;
        }

        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 12px;
            margin: 25px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 12px;
            background: linear-gradient(to right, var(--secondary), var(--purple));
            border-radius: 12px;
            width: 0%;
            transition: width 0.4s ease;
        }

        .questions-counter {
            text-align: right;
            font-size: 0.95rem;
            color: #6c757d;
            margin-top: 8px;
            font-weight: 600;
        }

        .daily-chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 35px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .daily-chart-container h3 {
            color: var(--primary);
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .daily-chart-container h3 i {
            font-size: 1.4rem;
            color: var(--secondary);
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .chart-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .chart-btn {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .chart-btn.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }

        .popup-content {
            text-align: center;
        }

        .popup-content h3 {
            color: var(--primary);
            margin-bottom: 15px;
        }

        .popup-content p {
            color: #475569;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        @media (max-width: 992px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 10px;
            }

            .form-section {
                padding: 20px;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .orders-table {
                font-size: 0.9rem;
            }

            .orders-table th,
            .orders-table td {
                padding: 10px 12px;
            }

            .btn-submit, .btn-whatsapp {
                max-width: 100%;
            }

            .chart-controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-clipboard-check"></i>
                <div>
                    <h1>VALIDACAO DE ORDENS DE SERVICO</h1>
                    <p class="subtitle">SISTEMA PARA VALIDACAO E CONTROLE DE QUALIDADE - AGE FIBRA</p>
                </div>
            </div>
        </header>

        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i>
            <div class="notification-content">NOTIFICACAO</div>
        </div>

        <div class="statistics" id="statistics">
            <div class="stat-card">
                <div class="stat-value" id="totalOS">0</div>
                <div class="stat-label">TOTAL DE OS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="approvedOS">0</div>
                <div class="stat-label">OS APROVADAS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="rejectedOS">0</div>
                <div class="stat-label">OS REPROVADAS</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayOS">0</div>
                <div class="stat-label">NOTAS HOJE</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayRejectedOS">0</div>
                <div class="stat-label">OS REPROVADAS HOJE</div>
            </div>
        </div>

        <div class="daily-chart-container">
            <h3><i class="fas fa-chart-line"></i> QUANTIDADE DE NOTAS POR DIA</h3>
            <div class="chart-controls">
                <button class="chart-btn active" id="btn7d" data-days="7">7 DIAS</button>
                <button class="chart-btn" id="btn15d" data-days="15">15 DIAS</button>
                <button class="chart-btn" id="btn30d" data-days="30">30 DIAS</button>
            </div>
            <div class="chart-wrapper">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>

        <main>
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-user"></i>
                    <h2>INFORMACOES DA ORDEM DE SERVICO</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="operator" class="required">OPERADOR</label>
                        <select id="operator" required>
                            <option value="">SELECIONE UM OPERADOR</option>
                            <option>CAMILA BRITO PEREIRA</option>
                            <option>JOAO VICTOR BORGES LIMA</option>
                            <option>MARCOS BARROS DE OLIVEIRA</option>
                            <option>DAVI SOARES DE SA</option>
                            <option>RICARDO RODRIGUES LIMA</option>
                            <option>HELENA BISPO DA SILVA</option>
                            <option>ELINE VIEIRA GERONIMO DE PAULO</option>
                            <option>JULIANE MIRANDA DE ARAUJO</option>
                            <option>LUCIENE SOUSA DA SILVA</option>
                            <option>RAYLANE STEFANY SILVA DA COSTA</option>
                            <option>ROBSON DE OLIVEIRA SILVA</option>
                            <option>BARBARA HYAD NUNES SIQUEIRA</option>
                            <option>VICKTORIA GONCALVES FREIRE MOTTA</option>
                            <option>ANA PAULA ALVES LIMA</option>
                            <option>LAURA BORGES LIMA</option>
                            <option>MARCIO VINICUS</option>
                            <option>TAMARA LAURA SOUSA SOARES</option>
                            <option>KALINE MORAIS DOS SANTOS</option>
                            <option>THAYENE DOS SANTOS FERREIRA</option>
                            <option>FELIPE JUNIOR</option>
                            <option>BARBARA SILVA DOS SANTOS</option>
                            <option>MICHELLY SUPERVISAO</option>
                            <option>RALMARLEY SUPERVISAO</option>
                            <option>MAIARA SILVA LIMA</option>
                            <option>THALITA VITORIA BORGES SOUSA</option>
                            <option>ELISANGELA DE JESUS FERNANDES</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="supervisor" class="required">SUPERVISOR</label>
                        <select id="supervisor" required>
                            <option value="">SELECIONE UM SUPERVISOR</option>
                            <option>WASHINGTON MELO</option>
                            <option>PATRICK DE SOUSA BARRETO</option>
                            <option>MARCOS VINICIUS</option>
                            <option>JOAO PAULO</option>
                            <option>GUILHERME</option>
                            <option>JONATHAN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="technician" class="required">TECNICO</label>
                        <select id="technician" required>
                            <option value="">SELECIONE UM TECNICO</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="client" class="required">NOME COMPLETO DO CLIENTE</label>
                        <input type="text" id="client" placeholder="DIGITE O NOME COMPLETO DO CLIENTE" required>
                    </div>
                    <div class="form-group">
                        <label for="service-type" class="required">TIPO DE ORDEM DE SERVICO</label>
                        <select id="service-type" required disabled>
                            <option value="">SELECIONE O TIPO DE SERVICO</option>
                            <option>ATIVACAO</option>
                            <option>MUDANCA DE ENDERECO</option>
                            <option>VISITA TECNICA</option>
                            <option>UPGRADE MESH</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="order-type">TIPO DE ORDEM</label>
                        <div class="radio-option">
                            <input type="checkbox" id="order-type" name="order-type" value="B2B">
                            <label for="order-type">B2B (MARCAR SE FOR B2B, DEIXAR DESMARCADO PARA B2C)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-tasks"></i>
                    <h2>VALIDACAO TECNICA</h2>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="questions-counter" id="questionsCounter">0/8 PERGUNTAS RESPONDIDAS</div>

                <div class="validation-item active" id="question-1">
                    <div class="validation-text">
                        <div class="validation-title">1. FOTOS OBRIGATORIAS INSERIDAS NO VTASKS?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="photos-yes" name="photos" value="sim" required>
                                <label for="photos-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="photos-no" name="photos" value="nao" required>
                                <label for="photos-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="photos-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>

                <div class="validation-item" id="question-2">
                    <div class="validation-text">
                        <div class="validation-title">2. VIDEO AVALIADO E DE ACORDO COM A QUALIDADE AGE FIBRA?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="video-yes" name="video" value="sim" required>
                                <label for="video-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="video-no" name="video" value="nao" required>
                                <label for="video-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="video-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>

                <div class="validation-item" id="question-3">
                    <div class="validation-text">
                        <div class="validation-title">3. FORAM REALIZADOS TESTES EM SITES?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="sites-yes" name="sites" value="sim" required>
                                <label for="sites-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="sites-no" name="sites" value="nao" required>
                                <label for="sites-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="sites-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>

                <div class="validation-item" id="question-4">
                    <div class="validation-text">
                        <div class="validation-title">4. FORAM REALIZADOS TESTES EM APLICATIVOS?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="apps-yes" name="apps" value="sim" required>
                                <label for="apps-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="apps-no" name="apps" value="nao" required>
                                <label for="apps-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="apps-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>

                <div class="validation-item" id="question-5">
                    <div class="validation-text">
                        <div class="validation-title">5. CLIENTE FOI ORIENTADO QUANTO AS REDES 2.4 GHZ E 5 GHZ E CABO?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="orientation-yes" name="orientation" value="sim" required>
                                <label for="orientation-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="orientation-no" name="orientation" value="nao" required>
                                <label for="orientation-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="orientation-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>

                <div class="validation-item" id="question-6">
                    <div class="validation-text">
                        <div class="validation-title">6. AMBIENTE FICOU LIMPO E ORGANIZADO?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="clean-yes" name="clean" value="sim" required>
                                <label for="clean-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="clean-no" name="clean" value="nao" required>
                                <label for="clean-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="clean-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>

                <div class="validation-item" id="question-7">
                    <div class="validation-text">
                        <div class="validation-title">7. NUMERO DO SUPORTE TECNICO AGE FIBRA?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="support-yes" name="support" value="sim" required>
                                <label for="support-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="support-no" name="support" value="nao" required>
                                <label for="support-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="support-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>

                <div class="validation-item" id="question-8">
                    <div class="validation-text">
                        <div class="validation-title">8. TODAS AS DUVIDAS DO CLIENTE FORAM SANADAS?</div>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="doubts-yes" name="doubts" value="sim" required>
                                <label for="doubts-yes">SIM</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="doubts-no" name="doubts" value="nao" required>
                                <label for="doubts-no">NAO</label>
                            </div>
                        </div>
                        <div class="comment-field">
                            <input type="text" id="doubts-comment" placeholder="COMENTARIOS (OPCIONAL)">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    <h2>RESULTADO DA VALIDACAO</h2>
                </div>
                <div class="form-group">
                    <label for="validation" class="required">VALIDACAO</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="approved" name="validation" value="approved" required>
                            <label for="approved">APROVADA</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="rejected" name="validation" value="rejected" required>
                            <label for="rejected">REPROVADA</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="closing-type" class="required">TIPO DE FECHAMENTO</label>
                    <input type="text" id="closing-type" placeholder="DIGITE O TIPO DE FECHAMENTO" required>
                </div>
                <div class="form-group">
                    <label for="observations">OBSERVACOES</label>
                    <textarea id="observations" rows="4" placeholder="DIGITE OBSERVACOES RELEVANTES SOBRE A VALIDACAO"></textarea>
                </div>
                <div class="rejection-reason" id="rejectionReason">
                    <div class="form-group">
                        <label for="rejection-details" class="required">MOTIVO DA REPROVACAO</label>
                        <textarea id="rejection-details" rows="3" placeholder="DESCREVA DETALHADAMENTE O MOTIVO DA REPROVACAO" required></textarea>
                    </div>
                </div>
            </div>

            <button class="btn-submit" id="submitBtn">
                <i class="fas fa-check-circle"></i> VALIDAR ORDEM DE SERVICO
            </button>

            <button class="btn-whatsapp" id="whatsappBtn">
                <i class="fab fa-whatsapp"></i> ENVIAR POR WHATSAPP
            </button>

            <div class="last-orders">
                <h3><i class="fas fa-history"></i> ULTIMAS 5 ORDENS VALIDADAS</h3>
                <div id="ordersTableContainer">
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>DATA</th>
                                <th>OPERADOR</th>
                                <th>TECNICO</th>
                                <th>CLIENTE</th>
                                <th>TIPO ORDEM</th>
                                <th>STATUS</th>
                                <th>FECHAMENTO</th>
                                <th>ACOES</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center;">CARREGANDO DADOS...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button class="export-btn" id="exportBtn">
                    <i class="fas fa-file-excel"></i> EXPORTAR PARA EXCEL
                </button>
            </div>
        </main>

        <div class="popup-overlay" id="popupOverlay"></div>
        <div class="popup" id="validationPopup">
            <div class="popup-content">
                <h3>INFORMACAO IMPORTANTE</h3>
                <p>INFORME AO TECNICO SE A ORDEM FOI VALIDADA OU NAO. EM CASO DE NAO VALIDADA, INSTRUIR O TECNICO A CORRIGIR OS PROBLEMAS E RETORNAR PARA NOVA VALIDACAO.</p>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="closePopupBtn">ENTENDIDO</button>
                </div>
            </div>
        </div>

        <footer>
            <p>SISTEMA DE VALIDACAO DE OS - AGE FIBRA | DESENVOLVIDO COM <i class="fas fa-heart" style="color: var(--secondary);"></i> PARA QUALIDADE DO ATENDIMENTO</p>
            <p>2025 TODOS OS DIREITOS RESERVADOS</p>
        </footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBwTvjKbFP3AIyEhlihsf7VDtafjxAvM24",
            authDomain: "validaage.firebaseapp.com",
            projectId: "validaage",
            storageBucket: "validaage.appspot.com",
            messagingSenderId: "654383800536",
            appId: "1:654383800536:web:1d247bb420b1f91dea77ad",
            measurementId: "G-CWSFTXQ3T2"
        };

        const notification = document.getElementById('notification');
        const notificationContent = document.querySelector('.notification-content');
        const submitBtn = document.getElementById('submitBtn');
        const exportBtn = document.getElementById('exportBtn');
        const whatsappBtn = document.getElementById('whatsappBtn');
        const progressBar = document.getElementById('progressBar');
        const questionsCounter = document.getElementById('questionsCounter');
        const totalOS = document.getElementById('totalOS');
        const approvedOS = document.getElementById('approvedOS');
        const rejectedOS = document.getElementById('rejectedOS');
        const todayOS = document.getElementById('todayOS');
        const todayRejectedOS = document.getElementById('todayRejectedOS');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const operatorSelect = document.getElementById('operator');
        const supervisorSelect = document.getElementById('supervisor');
        const technicianSelect = document.getElementById('technician');
        const clientInput = document.getElementById('client');
        const serviceTypeSelect = document.getElementById('service-type');
        const orderTypeCheckbox = document.getElementById('order-type');
        const closingTypeInput = document.getElementById('closing-type');
        const questions = document.querySelectorAll('.validation-item');
        const rejectionReason = document.getElementById('rejectionReason');
        const rejectionDetails = document.getElementById('rejection-details');
        const popupOverlay = document.getElementById('popupOverlay');
        const validationPopup = document.getElementById('validationPopup');
        const closePopupBtn = document.getElementById('closePopupBtn');

        const tecnicosPorSupervisor = {
            "WASHINGTON MELO": [
                { nome: "BRUNO HENRIQUE SANTOS DE LIMA", codigo: "V19001" },
                { nome: "DAVID ICARO PEREIRA BARROS", codigo: "V19002" },
                { nome: "GUILHERME RODRIGUES BEZERRA", codigo: "V19003" },
                { nome: "MABIO DA CONCEICAO O RIBEIRO", codigo: "V19004" },
                { nome: "MARCOS HENRIQUE VELOSO", codigo: "V19005" },
                { nome: "PHILIPE DA SILVA BARROS", codigo: "V19006" },
                { nome: "WAGNER RODRIGUES UCHOA", codigo: "V19007" },
                { nome: "WALLESSON MATHEUS RIBEIRO ARAUJO", codigo: "V19008" },
                { nome: "WARLEY MARTINS NASCIMENTO", codigo: "V19009" },
                { nome: "SAVIO DOS REIS FERREIRA", codigo: "V19010" },
                { nome: "MATHEUS EMANOEL DE SOUSA FERREIRA", codigo: "V19011" }
            ],
            "PATRICK DE SOUSA BARRETO": [
                { nome: "WAGNER FELIX DA SILVA", codigo: "V20001" },
                { nome: "MATHEUS QUEIROZ BOAVENTURA", codigo: "V20002" },
                { nome: "THIAGO EMANUEL S DOURADO", codigo: "V20003" },
                { nome: "ITALO ALENCAR NERES", codigo: "V20004" },
                { nome: "BRUNO MARQUES PIRES", codigo: "V20005" },
                { nome: "FILIPE BARROS BATISTA", codigo: "V20006" },
                { nome: "MAXSUEL DA SILVA SANTOS", codigo: "V20007" },
                { nome: "NATHAN DUTRA CAETANO", codigo: "V20008" },
                { nome: "MAURILIO AMARO DA SILVA", codigo: "V20009" },
                { nome: "MARCOS HENRIQUE PUSSENTE COUTO", codigo: "V20010" },
                { nome: "MAYCOM MEDEIROS DA SILVA DO CARMO", codigo: "V20011" }
            ],
            "MARCOS VINICIUS": [
                { nome: "EDNALDO LOPES RIBEIRO", codigo: "V21001" },
                { nome: "FILIPE CASTRO DE OLIVEIRA", codigo: "V21002" },
                { nome: "GILVAN ALVES FELISBERTO", codigo: "V21003" },
                { nome: "MAGNO MIRANDA RODRIGUES", codigo: "V21004" },
                { nome: "MARCELO MARTINS FERREIRA", codigo: "V21005" },
                { nome: "MARLLON ANDREY FREITAS DIAS", codigo: "V21006" },
                { nome: "MATEUS PEREIRA DA SILVA", codigo: "V21007" },
                { nome: "MICHAEL ANDERSON SILVA LIMA", codigo: "V21008" },
                { nome: "PAULO ROBERTO FERREIRA CAVALCANTE", codigo: "V21009" },
                { nome: "PAULO VICTOR DA SILVA", codigo: "V21010" },
                { nome: "THIAGO DA SILVA SIQUEIRA", codigo: "V21011" },
                { nome: "WANDERSON BARBOSA DOS ANJOS", codigo: "V21012" },
                { nome: "WELINTON PEREIRA FREIRE", codigo: "V21013" },
                { nome: "WILCKSON DIAS DA SILVA", codigo: "V21014" },
                { nome: "PAULO HENRIQUE SOUSA DA SILVA", codigo: "V21015" },
                { nome: "SAMUEL BATISTA DA SILVA", codigo: "V21016" },
                { nome: "LUIZ PHELIPE RODRIGUES DOS SANTOS", codigo: "V21017" }
            ],
            "JOAO PAULO": [
                { nome: "PEDRO HENRIQUE DA SILVA NOGUEIRA", codigo: "V22001" },
                { nome: "ANDRE LUIS MARTINS NASCIMENTO", codigo: "V22002" },
                { nome: "ANTONIO MARCOS DOS SANTOS FIGUEIRA", codigo: "V22003" },
                { nome: "CARLOS ANDRE DE OLIVEIRA PORTO", codigo: "V22004" },
                { nome: "DANIEL ANTONIO BATISTA DE SOUSA", codigo: "V22005" },
                { nome: "DANIEL CRISTIANO DE JESUS", codigo: "V22006" },
                { nome: "DAVID FREIRE LEMOS", codigo: "V22007" },
                { nome: "DELCIO FERNANDES DE ARAUJO", codigo: "V22008" },
                { nome: "HEVERTON REIS VENCESLAU", codigo: "V22009" },
                { nome: "ITAMAR CORDEIRO DE SOUZA", codigo: "V22010" },
                { nome: "JEOVANI PEREIRA DE ALMEIDA", codigo: "V22011" },
                { nome: "MATHEUS RODRIGUES DOS ANJOS", codigo: "V22012" },
                { nome: "MAYKON WESLEY GOMES DA SILVA", codigo: "V22013" },
                { nome: "MOISES FERNANDO DE JESUS TEIXEIRA", codigo: "V22014" },
                { nome: "PABLO MORAIS GONCALVES", codigo: "V22015" },
                { nome: "PEDRO HENRIQUE SOARES DOS SANTOS", codigo: "V22016" },
                { nome: "THYAGO CARDOSO SOBRINHO", codigo: "V22017" },
                { nome: "UEDER PEREIRA DE MORAIS", codigo: "V22018" },
                { nome: "WAGNER GOMES PEIXOTO JUNIOR", codigo: "V22019" }
            ],
            "GUILHERME": [
                { nome: "DANIEL NASCIMENTO SOARES", codigo: "V23001" },
                { nome: "FELIPE MORAIS DE LUCENA", codigo: "V23002" },
                { nome: "GABRIEL MULLER MARTINS DE MEDEIROS", codigo: "V23003" },
                { nome: "LUCAS NASCIMENTO DOS SANTOS", codigo: "V23004" },
                { nome: "MATEUS VIEIRA DE SOUSA", codigo: "V23005" },
                { nome: "BRUNO DA SILVA BARBOSA", codigo: "V23006" },
                { nome: "JOSE WANDDERSON SOUSA DO NASCIMENTO", codigo: "V23007" },
                { nome: "WILKER RODRIGUES PINTO", codigo: "V23008" }
            ],
            "JONATHAN": [
                { nome: "KLEYTON DOUGLAS DOS SANTOS SILVA", codigo: "V24001" },
                { nome: "WILLBAN MARQUES DA SILVA", codigo: "V24002" },
                { nome: "WILLIANS ANUNCIACAO ALBUQUERQUE", codigo: "V24003" },
                { nome: "ELISEU CLEFFERSON LOPES DA SILVA", codigo: "V24004" },
                { nome: "ALOI LIMA DE SANTANA", codigo: "V24005" },
                { nome: "ANTONIO FILIPE RICARTE LOURENCO DOS SANTOS", codigo: "V24006" },
                { nome: "DIEGO EDGARD SOARES", codigo: "V24007" },
                { nome: "SAMUEL BARBOSA DE CASTRO", codigo: "V24008" },
                { nome: "VITOR GUIMARAES DO PRADO", codigo: "V24009" },
                { nome: "JOSIAS FERREIRA BARBOSA", codigo: "V24010" },
                { nome: "MESAQUE SALVIANO DA SILVA", codigo: "V24011" },
                { nome: "PAULO HENRIQUE A DA CRUZ", codigo: "V24012" },
                { nome: "DOUGLAS DA SILVA MADEIRA", codigo: "V24013" },
                { nome: "FELIPE MARTINS DIAS", codigo: "V24014" },
                { nome: "ROMARIO OLIVEIRA CAMPOS", codigo: "V24015" },
                { nome: "RAFAEL LIMA DE OLIVEIRA", codigo: "V24016" },
                { nome: "FELIPE DE SOUSA RODRIGUES", codigo: "V24017" }
            ]
        };

        let db;
        let analytics;
        let firebaseConnected = false;
        let orders = [];
        let answeredQuestions = 0;
        let dailyChart;
        let chartDays = 7;

        function normalizeText(text) {
            return text
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .toUpperCase();
        }

        function showNotification(message, isSuccess = true) {
            notificationContent.textContent = message;
            notification.innerHTML = `<i class="fas ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${notificationContent.outerHTML}`;
            notification.className = `notification ${isSuccess ? 'success' : 'error'} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        function showPopup() {
            popupOverlay.style.display = 'block';
            validationPopup.style.display = 'block';
        }

        function hidePopup() {
            popupOverlay.style.display = 'none';
            validationPopup.style.display = 'none';
        }

        function preencherTecnicos() {
            const supervisor = supervisorSelect.value;
            technicianSelect.innerHTML = '<option value="">SELECIONE UM TECNICO</option>';
            if (supervisor && tecnicosPorSupervisor[supervisor]) {
                tecnicosPorSupervisor[supervisor].forEach(tecnico => {
                    const option = document.createElement('option');
                    option.value = tecnico.nome;
                    option.textContent = `${tecnico.nome} (${tecnico.codigo})`;
                    technicianSelect.appendChild(option);
                });
            }
        }

        function updateProgressBar() {
            const progress = (answeredQuestions / 8) * 100;
            progressBar.style.width = `${progress}%`;
            questionsCounter.textContent = `${answeredQuestions}/8 PERGUNTAS RESPONDIDAS`;
        }

        function setupQuestionSequence() {
            questions.forEach((question, index) => {
                if (index === 0) {
                    question.classList.add('active');
                } else {
                    question.classList.remove('active');
                }
                const radios = question.querySelectorAll('input[type="radio"]');
                radios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        question.classList.add('completed');
                        answeredQuestions++;
                        updateProgressBar();
                        if (index < questions.length - 1) {
                            questions[index + 1].classList.add('active');
                            questions[index + 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                });
            });
        }

        function checkRejectionStatus() {
            const rejectedRadio = document.getElementById('rejected');
            rejectionReason.style.display = rejectedRadio.checked ? 'block' : 'none';
            rejectionDetails.required = rejectedRadio.checked;
        }

        async function loadOrders() {
            if (!firebaseConnected) {
                showNotification('SEM CONEXAO COM FIREBASE. VERIFIQUE A CONFIGURACAO.', false);
                return;
            }
            try {
                const snapshot = await db.collection("ordens_servico").get();
                orders = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                snapshot.forEach(doc => {
                    const data = doc.data();
                    orders.push({
                        id: doc.id,
                        operator: normalizeText(data.operator),
                        supervisor: normalizeText(data.supervisor),
                        technician: normalizeText(data.technician),
                        client: normalizeText(data.client),
                        serviceType: normalizeText(data.serviceType),
                        orderType: data.orderType || 'B2C',
                        closingType: normalizeText(data.closingType || ''),
                        validation: data.validation,
                        result: data.result,
                        observations: data.observations,
                        rejectionReason: data.rejectionReason,
                        timestamp: data.timestamp
                    });
                });

                totalOS.textContent = orders.length;
                approvedOS.textContent = orders.filter(order => order.result === 'approved').length;
                rejectedOS.textContent = orders.filter(order => order.result === 'rejected').length;
                todayOS.textContent = orders.filter(order => {
                    const orderDate = order.timestamp.toDate();
                    orderDate.setHours(0, 0, 0, 0);
                    return orderDate.getTime() === today.getTime();
                }).length;
                todayRejectedOS.textContent = orders.filter(order => {
                    const orderDate = order.timestamp.toDate();
                    orderDate.setHours(0, 0, 0, 0);
                    return orderDate.getTime() === today.getTime() && order.result === 'rejected';
                }).length;

                const sortedOrders = [...orders].sort((a, b) => b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime());
                ordersTableBody.innerHTML = sortedOrders.length === 0
                    ? '<tr><td colspan="8" style="text-align: center;">NENHUMA ORDEM VALIDADA AINDA</td></tr>'
                    : sortedOrders.slice(0, 5).map(order => {
                        const date = order.timestamp.toDate();
                        const formattedDate = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR');
                        const orderDate = new Date(date);
                        orderDate.setHours(0, 0, 0, 0);
                        const isToday = orderDate.getTime() === today.getTime();
                        return `
                            <tr class="${isToday ? 'today-order' : ''}">
                                <td>${formattedDate}</td>
                                <td>${order.operator}</td>
                                <td>${order.technician}</td>
                                <td>${order.client}</td>
                                <td>${order.orderType}</td>
                                <td class="${order.result === 'approved' ? 'status-approved' : 'status-rejected'}">
                                    ${order.result === 'approved' ? 'APROVADA' : 'REPROVADA'}
                                </td>
                                <td>${order.closingType || 'NAO INFORMADO'}</td>
                                <td>
                                    <button class="delete-btn" data-id="${order.id}">
                                        <i class="fas fa-trash"></i> EXCLUIR
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => deleteOrder(btn.getAttribute('data-id')));
                });

                updateDailyChart();
            } catch (error) {
                console.error("ERRO AO CARREGAR DADOS:", error.code, error.message);
                showNotification('ERRO AO CARREGAR DADOS: ' + error.message + ' (' + error.code + ')', false);
            }
        }

        function updateDailyChart() {
            const ordersByDay = {};
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dates = [];
            for (let i = chartDays - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(today.getDate() - i);
                date.setHours(0, 0, 0, 0);
                const dateStr = date.toLocaleDateString('pt-BR');
                dates.push(dateStr);
                ordersByDay[dateStr] = 0;
            }

            orders.forEach(order => {
                const orderDate = order.timestamp.toDate();
                orderDate.setHours(0, 0, 0, 0);
                const orderDateStr = orderDate.toLocaleDateString('pt-BR');
                if (ordersByDay.hasOwnProperty(orderDateStr)) {
                    ordersByDay[orderDateStr]++;
                }
            });

            const chartData = dates.map(date => ordersByDay[date] || 0);
            const ctx = document.getElementById('dailyChart').getContext('2d');

            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'NOTAS VALIDADAS',
                        data: chartData,
                        backgroundColor: 'rgba(67, 97, 238, 0.7)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(44, 62, 80, 0.9)',
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 },
                            padding: 10,
                            displayColors: false
                        }
                    }
                }
            });
        }

        async function deleteOrder(orderId) {
            if (!confirm('TEM CERTEZA QUE DESEJA EXCLUIR ESTA ORDEM?')) return;
            try {
                await db.collection("ordens_servico").doc(orderId).delete();
                showNotification('ORDEM EXCLUIDA COM SUCESSO!', true);
                loadOrders();
            } catch (error) {
                console.error("ERRO AO EXCLUIR ORDEM:", error);
                showNotification('ERRO AO EXCLUIR ORDEM: ' + error.message, false);
            }
        }

        function sendViaWhatsApp() {
            const operator = operatorSelect.value || 'NAO INFORMADO';
            const technician = technicianSelect.value || 'NAO INFORMADO';
            const client = clientInput.value || 'NAO INFORMADO';
            const serviceType = serviceTypeSelect.value || 'NAO INFORMADO';
            const orderType = orderTypeCheckbox.checked ? 'B2B' : 'B2C';
            const closingType = closingTypeInput.value || 'NAO INFORMADO';
            const result = document.querySelector('input[name="validation"]:checked')?.value === 'approved' ? 'APROVADA' : 'REPROVADA';

            let message = `*VALIDACAO DE OS - AGE FIBRA*\n\n`;
            message += `*OPERADOR:* ${operator}\n`;
            message += `*TECNICO:* ${technician}\n`;
            message += `*CLIENTE:* ${client}\n`;
            message += `*TIPO DE OS:* ${serviceType}\n`;
            message += `*TIPO DE ORDEM:* ${orderType}\n`;
            message += `*TIPO DE FECHAMENTO:* ${closingType}\n`;
            message += `*RESULTADO:* ${result}\n\n`;

            const questionTitles = [
                "FOTOS OBRIGATORIAS INSERIDAS NO VTASKS?",
                "VIDEO AVALIADO E DE ACORDO COM A QUALIDADE AGE FIBRA?",
                "FORAM REALIZADOS TESTES EM SITES?",
                "FORAM REALIZADOS TESTES EM APLICATIVOS?",
                "CLIENTE FOI ORIENTADO QUANTO AS REDES 2.4 GHZ E 5 GHZ E CABO?",
                "AMBIENTE FICOU LIMPO E ORGANIZADO?",
                "NUMERO DO SUPORTE TECNICO AGE FIBRA?",
                "TODAS AS DUVIDAS DO CLIENTE FORAM SANADAS?"
            ];

            questionTitles.forEach((title, index) => {
                const questionId = `question-${index + 1}`;
                const questionElement = document.getElementById(questionId);
                const radios = questionElement.querySelectorAll('input[type="radio"]');
                const comment = document.getElementById(`${title.split(' ')[0].toLowerCase()}-comment`)?.value || '';
                let response = 'NAO RESPONDIDO';
                radios.forEach(radio => {
                    if (radio.checked) response = radio.value.toUpperCase();
                });
                message += `- *${title}*: ${response}${comment ? ` (${comment})` : ''}\n`;
            });

            const observations = document.getElementById('observations').value;
            if (observations) message += `\n*OBSERVACOES:* ${observations}\n`;
            if (result === 'REPROVADA' && rejectionDetails.value) {
                message += `\n*MOTIVO DA REPROVACAO:* ${rejectionDetails.value}\n`;
            }

            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
        }

        function exportToExcel() {
            if (!orders.length) {
                showNotification('NENHUMA ORDEM PARA EXPORTAR', false);
                return;
            }

            const dataForExport = orders.map(order => {
                const date = order.timestamp.toDate();
                return {
                    'DATA': date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR'),
                    'OPERADOR': order.operator,
                    'SUPERVISOR': order.supervisor,
                    'TECNICO': order.technician,
                    'CLIENTE': order.client,
                    'TIPO DE OS': order.serviceType,
                    'TIPO DE ORDEM': order.orderType,
                    'TIPO DE FECHAMENTO': order.closingType || '',
                    'FOTOS': order.validation.photos || 'NAO RESPONDIDO',
                    'VIDEO': order.validation.video || 'NAO RESPONDIDO',
                    'SITES': order.validation.sites || 'NAO RESPONDIDO',
                    'APLICATIVOS': order.validation.apps || 'NAO RESPONDIDO',
                    'ORIENTACAO': order.validation.orientation || 'NAO RESPONDIDO',
                    'LIMPEZA': order.validation.clean || 'NAO RESPONDIDO',
                    'SUPORTE': order.validation.support || 'NAO RESPONDIDO',
                    'DUVIDAS': order.validation.doubts || 'NAO RESPONDIDO',
                    'COMENTARIO FOTOS': order.validation.photosComment || '',
                    'COMENTARIO VIDEO': order.validation.videoComment || '',
                    'COMENTARIO SITES': order.validation.sitesComment || '',
                    'COMENTARIO APLICATIVOS': order.validation.appsComment || '',
                    'COMENTARIO ORIENTACAO': order.validation.orientationComment || '',
                    'COMENTARIO LIMPEZA': order.validation.cleanComment || '',
                    'COMENTARIO SUPORTE': order.validation.supportComment || '',
                    'COMENTARIO DUVIDAS': order.validation.doubtsComment || '',
                    'RESULTADO': order.result === 'approved' ? 'APROVADA' : 'REPROVADA',
                    'OBSERVACOES': order.observations || '',
                    'MOTIVO REPROVACAO': order.rejectionReason || ''
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(dataForExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ORDENS DE SERVICO");
            XLSX.writeFile(workbook, "ordens_servico_age_fibra.xlsx");
            showNotification('DADOS EXPORTADOS COM SUCESSO!', true);
        }

        function initFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                analytics = firebase.analytics();
                firebaseConnected = true;
                showNotification('CONEXAO COM FIREBASE ESTABELECIDA!', true);
                loadOrders();
            } catch (error) {
                console.error("ERRO AO INICIALIZAR FIREBASE:", error.code, error.message);
                firebaseConnected = false;
                showNotification('ERRO NA CONEXAO COM FIREBASE: ' + error.message + ' (' + error.code + ')', false);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            setupQuestionSequence();

            supervisorSelect.addEventListener('change', () => {
                preencherTecnicos();
                serviceTypeSelect.disabled = !operatorSelect.value || !supervisorSelect.value || !technicianSelect.value || !clientInput.value;
            });

            technicianSelect.addEventListener('change', () => {
                serviceTypeSelect.disabled = !operatorSelect.value || !supervisorSelect.value || !technicianSelect.value || !clientInput.value;
            });

            operatorSelect.addEventListener('change', () => {
                serviceTypeSelect.disabled = !operatorSelect.value || !supervisorSelect.value || !technicianSelect.value || !clientInput.value;
            });

            clientInput.addEventListener('input', () => {
                serviceTypeSelect.disabled = !operatorSelect.value || !supervisorSelect.value || !technicianSelect.value || !clientInput.value;
            });

            document.querySelectorAll('input[name="validation"]').forEach(radio => {
                radio.addEventListener('change', checkRejectionStatus);
            });

            submitBtn.addEventListener('click', async () => {
                if (!firebaseConnected) {
                    showNotification('SEM CONEXAO COM FIREBASE.', false);
                    return;
                }

                const operator = operatorSelect.value;
                const supervisor = supervisorSelect.value;
                const technician = technicianSelect.value;
                const client = clientInput.value;
                const serviceType = serviceTypeSelect.value;
                const orderType = orderTypeCheckbox.checked ? 'B2B' : 'B2C';
                const closingType = closingTypeInput.value;
                const result = document.querySelector('input[name="validation"]:checked')?.value;
                const observations = document.getElementById('observations').value;
                const rejectionDetailsValue = rejectionDetails.value;

                if (!operator || !supervisor || !technician || !client || !serviceType || !result || !closingType) {
                    showNotification('PREENCHA TODOS OS CAMPOS OBRIGATORIOS.', false);
                    return;
                }

                if (result === 'rejected' && !rejectionDetailsValue) {
                    showNotification('ESPECIFIQUE O MOTIVO DA REPROVACAO.', false);
                    return;
                }

                if (answeredQuestions < 8) {
                    showNotification('RESPONDA TODAS AS PERGUNTAS DE VALIDACAO.', false);
                    return;
                }

                const validationData = {
                    operator: normalizeText(operator),
                    supervisor: normalizeText(supervisor),
                    technician: normalizeText(technician),
                    client: normalizeText(client),
                    serviceType: normalizeText(serviceType),
                    orderType: orderType,
                    closingType: normalizeText(closingType),
                    validation: {
                        photos: document.querySelector('input[name="photos"]:checked')?.value,
                        video: document.querySelector('input[name="video"]:checked')?.value,
                        sites: document.querySelector('input[name="sites"]:checked')?.value,
                        apps: document.querySelector('input[name="apps"]:checked')?.value,
                        orientation: document.querySelector('input[name="orientation"]:checked')?.value,
                        clean: document.querySelector('input[name="clean"]:checked')?.value,
                        support: document.querySelector('input[name="support"]:checked')?.value,
                        doubts: document.querySelector('input[name="doubts"]:checked')?.value,
                        photosComment: document.getElementById('photos-comment').value,
                        videoComment: document.getElementById('video-comment').value,
                        sitesComment: document.getElementById('sites-comment').value,
                        appsComment: document.getElementById('apps-comment').value,
                        orientationComment: document.getElementById('orientation-comment').value,
                        cleanComment: document.getElementById('clean-comment').value,
                        supportComment: document.getElementById('support-comment').value,
                        doubtsComment: document.getElementById('doubts-comment').value
                    },
                    result: result,
                    observations: observations,
                    rejectionReason: result === 'rejected' ? rejectionDetailsValue : '',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';
                    await db.collection("ordens_servico").add(validationData);
                    showNotification('ORDEM VALIDADA COM SUCESSO!', true);
                    showPopup();

                    operatorSelect.value = '';
                    supervisorSelect.value = '';
                    technicianSelect.innerHTML = '<option value="">SELECIONE UM TECNICO</option>';
                    clientInput.value = '';
                    serviceTypeSelect.value = '';
                    orderTypeCheckbox.checked = false;
                    closingTypeInput.value = '';
                    serviceTypeSelect.disabled = true;
                    document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                    document.querySelectorAll('.validation-item').forEach(item => {
                        item.classList.remove('completed');
                        item.classList.toggle('active', item.id === 'question-1');
                    });
                    document.getElementById('observations').value = '';
                    rejectionReason.style.display = 'none';
                    rejectionDetails.value = '';
                    answeredQuestions = 0;
                    updateProgressBar();
                    loadOrders();
                } catch (error) {
                    console.error("ERRO AO ENVIAR DADOS:", error);
                    showNotification('ERRO AO ENVIAR DADOS: ' + error.message, false);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> VALIDAR ORDEM DE SERVICO';
                }
            });

            closePopupBtn.addEventListener('click', hidePopup);

            exportBtn.addEventListener('click', exportToExcel);
            whatsappBtn.addEventListener('click', sendViaWhatsApp);

            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    chartDays = parseInt(btn.getAttribute('data-days'));
                    updateDailyChart();
                });
            });
        });
    </script>
</body>
</html>